# Tonight's Session Plan - Phase 4 Preparation

**Date:** December 7, 2025 (Evening Session)  
**Current Status:** Phase 3 Complete âœ…  
**Branch:** `feature/project-generator`  
**Last Commit:** `64a7227` - Phase 3: Implement DEVCFG register mapper

---

## What We Accomplished Today

âœ… **Phase 3 Complete** - DEVCFG Register Mapper
- Created `efhRegisterMap.ts` with 40-setting mapping
- Updated `ConfigEditor` to use real calculations
- Wrote comprehensive test suite (all tests passing)
- Documented complete bit field structures
- Committed to git

---

## Starting Point for Tonight

### Files Ready:
1. âœ… `src/devices/pic32mz/efhRegisterMap.ts` - Register calculation engine
2. âœ… `src/configEditor.ts` - Integrated with mapper
3. âœ… `src/test/registerMapperTest.ts` - Validation tests
4. âœ… `PHASE3_PROGRESS.md` - Complete documentation

### Known Issues to Address:
1. **String Mismatches** (~25 settings)
   - UI Schema uses abbreviated names
   - Register Map uses datasheet terminology
   - Need to align using PIC32MZ datasheet

### Prerequisites You're Adding:
- PIC32MZ datasheet in `docs/` folder

---

## Phase 4 Goals - Code Generators

### 1. Fix String Alignment (High Priority)
**Why:** Eliminates "Unknown value" warnings, ensures all settings work

**Approach:**
- Open PIC32MZ datasheet
- For each setting with mismatch, find exact datasheet option names
- Update either UI Schema OR Register Map for consistency
- Re-run tests to verify

**Example Fix:**
```typescript
// BEFORE (UI Schema)
options: ["MII Enabled", "RMII Enabled", "OFF"]

// AFTER (aligned with register map)
options: ["Alternate MII", "Default RMII"]
```

### 2. XC32 Code Generator
**Purpose:** Generate `#pragma config` statements for XC32 compiler

**Example Output:**
```c
// PIC32MZ2048EFH100 Configuration Bit Settings
// Generated by MikroC Bootloader Plugin

#pragma config FPLLIDIV = DIV_3        // System PLL Input Divider: 3x
#pragma config FPLLRNG = RANGE_5_10_MHZ // System PLL Input Range: 5-10 MHz
#pragma config FPLLICLK = PLL_POSC     // System PLL Input: POSC
#pragma config FPLLMULT = MUL_50       // System PLL Multiplier: 50x
#pragma config FPLLODIV = DIV_2        // System PLL Output Divider: 2x
// ... (all 40 settings)
```

**Implementation:**
- Create `src/generators/xc32Generator.ts`
- Map register values back to XC32 pragma names
- Use Microchip XC32 documentation for pragma syntax
- Add code comments with human-readable descriptions

### 3. MikroC Code Generator
**Purpose:** Generate device configuration code for MikroC compiler

**Example Output:**
```c
// PIC32MZ2048EFH100 Configuration
// Generated by MikroC Bootloader Plugin

void ConfigureDevice() {
    // DEVCFG3: Ethernet and Security Settings
    BF2DEVCFG3 = 0x43000000;
    
    // DEVCFG2: PLL Configuration (24 MHz â†’ 200 MHz)
    BF2DEVCFG2 = 0x40013190;
    
    // DEVCFG1: Oscillator and Watchdog Settings
    BF2DEVCFG1 = 0x5FEAC7F9;
    
    // DEVCFG0: Debug and Boot Configuration
    BF2DEVCFG0 = 0x403FF773;
}
```

**Implementation:**
- Create `src/generators/mikrocGenerator.ts`
- Use calculated register values directly
- Add register breakdown comments
- Include initialization function

### 4. Makefile Templates
**Purpose:** Generate build files for both compilers

**XC32 Makefile:**
```makefile
# PIC32MZ2048EFH100 XC32 Project
DEVICE = 32MZ2048EFH100
COMPILER = xc32-gcc
CFLAGS = -mprocessor=$(DEVICE) -O2 -Wall

all: main.hex

main.hex: main.c
	$(COMPILER) $(CFLAGS) -o main.elf main.c
	xc32-bin2hex main.elf
```

**MikroC Makefile:**
```makefile
# PIC32MZ2048EFH100 MikroC Project
DEVICE = P32MZ2048EFH100
COMPILER = mikroc32
PROJECT = main.mcp32

all: main.hex
	$(COMPILER) -P $(DEVICE) $(PROJECT)
```

---

## Implementation Order (Tonight)

### Step 1: String Alignment (30-45 min)
1. Open `PHASE3_PROGRESS.md` - see mismatch examples
2. Open PIC32MZ datasheet
3. For each mismatch, verify correct option names
4. Update `efhUiSchema.ts` OR `efhRegisterMap.ts`
5. Re-run test suite: `npm run compile && node out/test/registerMapperTest.js`
6. Commit: "Fix UI schema string alignment with datasheet"

### Step 2: XC32 Generator (45-60 min)
1. Create `src/generators/xc32Generator.ts`
2. Implement `generateXC32Config()` function
3. Create reverse mapping: register value â†’ pragma name
4. Add test file: `src/test/xc32GeneratorTest.ts`
5. Commit: "Add XC32 code generator"

### Step 3: MikroC Generator (30-45 min)
1. Create `src/generators/mikrocGenerator.ts`
2. Implement `generateMikroCConfig()` function
3. Format register values with comments
4. Add test file: `src/test/mikrocGeneratorTest.ts`
5. Commit: "Add MikroC code generator"

### Step 4: Makefile Templates (30 min)
1. Create `src/templates/xc32Makefile.template`
2. Create `src/templates/mikrocMakefile.template`
3. Add variable substitution logic
4. Commit: "Add Makefile templates for XC32/MikroC"

### Step 5: Integration & Testing (30 min)
1. Test complete workflow: Config â†’ Registers â†’ Code
2. Validate generated XC32 pragma syntax
3. Validate generated MikroC register writes
4. Update `PHASE4_PROGRESS.md`
5. Commit: "Phase 4 complete: Code generators working"

**Total Estimated Time:** 2.5 - 3.5 hours

---

## Reference Files Needed

### From Microchip:
- XC32 Compiler User's Guide (pragma syntax)
- PIC32MZ Family Reference Manual
- PIC32MZ2048EFH Datasheet (you're adding this)

### From MikroC:
- P32MZ2048EFH100.c (already have)
- WatchDog_Timer example (already have)
- Scheme files (already have)

---

## Success Criteria for Phase 4

1. âœ… All string mismatches resolved (test suite shows 0 warnings)
2. âœ… XC32 generator creates valid `#pragma config` statements
3. âœ… MikroC generator creates valid register write code
4. âœ… Both generators produce compilable output
5. âœ… Makefile templates work for both compilers
6. âœ… Test suite validates all generators
7. âœ… Documentation updated

---

## Quick Start Commands for Tonight

```bash
# Navigate to project
cd C:\Users\davec\GIT\mikroc-bootloader-plugin

# Check current status
git status
git log --oneline -5

# Run existing tests
npm run compile
node out/test/registerMapperTest.js

# Open in VS Code
code .

# Files to open first:
# 1. PHASE3_PROGRESS.md (review)
# 2. THIS_FILE (session plan)
# 3. src/devices/pic32mz/efhRegisterMap.ts (understand structure)
# 4. PIC32MZ datasheet (in docs folder)
```

---

## Questions to Consider

1. **XC32 Pragma Format:**
   - Should we group pragmas by category?
   - Include clock calculation comments?
   - Add warnings for non-default values?

2. **MikroC Output:**
   - Inline function vs separate .c file?
   - Include bit field explanations?
   - Add runtime validation?

3. **Template Variables:**
   - Project name
   - Device selection (100/124/144 pins)
   - Output directory
   - Optimization level

---

## After Phase 4 - Phase 5 Preview

**Phase 5: Full Project Generator**
- Folder picker dialog
- Device selection (8 EFH variants)
- Compiler selection (XC32/MikroC)
- Config editor (Phases 2-3)
- Code generation (Phase 4)
- File structure creation
- Makefile generation
- Build system integration

---

**Ready to Continue!** ðŸš€

When you start tonight:
1. Review this document
2. Check PHASE3_PROGRESS.md
3. Run test suite to confirm Phase 3 works
4. Start with string alignment (most impactful)
5. Then move to code generators

---

**Current Branch:** `feature/project-generator`  
**Latest Commit:** `64a7227`  
**Status:** âœ… Ready for Phase 4

# srcs/Makefile - Compilation rules for {{DEVICE_NAME}}
# Generated by MikroC Bootloader Plugin
# Based on Makefile_Generic/xc32-Makefiles structure

# Project configuration (passed from root Makefile)
MODULE ?= {{PROJECT_NAME}}
DEVICE ?= {{DEVICE_PART}}
BUILD_CONFIG ?= Release
HEAP_SIZE ?= {{HEAP_SIZE}}
STACK_SIZE ?= 0x1000

# DRY_RUN: Set to 1 to simulate directory operations without executing
DRY_RUN ?= 0

# Platform detection
ifeq ($(OS),Windows_NT)
	detected_OS := Windows
else
	detected_OS := $(shell uname -s)
endif

# Color codes for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m

# Cross-platform directory operations with DRY_RUN support
ifeq ($(detected_OS),Windows)
	ifeq ($(DRY_RUN),1)
		MKDIR = powershell -Command "Write-Host 'Would create directory: $(1)' -ForegroundColor Red"
		RMDIR = powershell -Command "Write-Host 'Would remove directory: $(1)' -ForegroundColor Red"
		MOVE = powershell -Command "Write-Host 'Would move file: $(1) -> $(2)' -ForegroundColor Red"
		RM = powershell -Command "Write-Host 'Would remove file: $(1)' -ForegroundColor Red"
	else
		MKDIR = powershell -Command "if (!(Test-Path '$(1)')) { New-Item -ItemType Directory -Path '$(1)' -Force | Out-Null; Write-Host 'Created directory: $(1)' -ForegroundColor Green }"
		RMDIR = powershell -Command "if (Test-Path '$(1)') { Remove-Item -Recurse -Force '$(1)'; Write-Host 'Removed directory: $(1)' -ForegroundColor Yellow }"
		MOVE = powershell -Command "if (Test-Path '$(1)') { Move-Item -Path '$(1)' -Destination '$(2)' -Force; Write-Host 'Moved: $(1) -> $(2)' -ForegroundColor Cyan }"
		RM = powershell -Command "if (Test-Path '$(1)') { Remove-Item -Force '$(1)'; Write-Host 'Removed: $(1)' -ForegroundColor Yellow }"
	endif
else
	ifeq ($(DRY_RUN),1)
		MKDIR = @echo "Would create directory: $(1)"
		RMDIR = @echo "Would remove directory: $(1)"
		MOVE = @echo "Would move file: $(1) -> $(2)"
		RM = @echo "Would remove file: $(1)"
	else
		MKDIR = @mkdir -p $(1) && echo "Created directory: $(1)"
		RMDIR = @rm -rf $(1) && echo "Removed directory: $(1)"
		MOVE = @mv -f $(1) $(2) && echo "Moved: $(1) -> $(2)"
		RM = @rm -f $(1) && echo "Removed: $(1)"
	endif
endif

# Auto-detect XC32 and DFP if not passed from root Makefile
ifeq ($(COMPILER_LOCATION),)
	ifeq ($(detected_OS),Windows)
		XC32_BASE := C:/Program Files/Microchip/xc32
		XC32_VERSION := $(shell powershell -Command "Get-ChildItem '$(XC32_BASE)' -Directory | Where-Object { $$_.Name -match '^v\d+\.\d+$$' } | Sort-Object Name -Descending | Select-Object -First 1 -ExpandProperty Name")
		COMPILER_LOCATION := $(XC32_BASE)/$(XC32_VERSION)/bin
	else
		XC32_BASE := /opt/microchip/xc32
		XC32_VERSION := $(shell ls -d $(XC32_BASE)/v* 2>/dev/null | sort -V | tail -n1 | xargs basename)
		COMPILER_LOCATION := $(XC32_BASE)/$(XC32_VERSION)/bin
	endif
endif

# Compiler paths
ifeq ($(detected_OS),Windows)
	CC := "$(COMPILER_LOCATION)/xc32-gcc.exe"
	LD := "$(COMPILER_LOCATION)/xc32-gcc.exe"
	AR := "$(COMPILER_LOCATION)/xc32-ar.exe"
	OBJCOPY := "$(COMPILER_LOCATION)/xc32-bin2hex.exe"
	SIZE := "$(COMPILER_LOCATION)/xc32-size.exe"
else
	CC := $(COMPILER_LOCATION)/xc32-gcc
	LD := $(COMPILER_LOCATION)/xc32-gcc
	AR := $(COMPILER_LOCATION)/xc32-ar
	OBJCOPY := $(COMPILER_LOCATION)/xc32-bin2hex
	SIZE := $(COMPILER_LOCATION)/xc32-size
endif

# DFP (Device Family Pack) paths
# Use DFP from root Makefile if provided, otherwise auto-detect
ifeq ($(DFP),)
	ifeq ($(detected_OS),Windows)
		MPLABX_BASE := C:/Program Files/Microchip/MPLABX
		MPLABX_VERSION := $(shell powershell -Command "Get-ChildItem '$(MPLABX_BASE)' -Directory | Where-Object { $$_.Name -match '^v\d+\.\d+$$' } | Sort-Object Name -Descending | Select-Object -First 1 -ExpandProperty Name")
		DFP_BASE := $(MPLABX_BASE)/$(MPLABX_VERSION)/packs/Microchip/PIC32MZ-EF_DFP
		DFP_VERSION := $(shell powershell -Command "Get-ChildItem '$(DFP_BASE)' -Directory | Sort-Object Name -Descending | Select-Object -First 1 -ExpandProperty Name")
	else
		MPLABX_BASE := /opt/microchip/mplabx
		MPLABX_VERSION := $(shell ls -d $(MPLABX_BASE)/v* 2>/dev/null | sort -V | tail -n1 | xargs basename)
		DFP_BASE := $(MPLABX_BASE)/$(MPLABX_VERSION)/packs/Microchip/PIC32MZ-EF_DFP
		DFP_VERSION := $(shell ls -d $(DFP_BASE)/* 2>/dev/null | sort -V | tail -n1 | xargs basename)
	endif
	DFP := $(DFP_BASE)/$(DFP_VERSION)
endif

DFP_PATH := $(DFP)
DFP_INC := $(DFP_PATH)/xc32
DFP_LIB := $(DFP_PATH)/xc32/$(DEVICE)/lib

# Directory structure (relative to srcs/)
ROOT_DIR := ..
SRC_DIR := .
INC_DIR := $(ROOT_DIR)/incs
BASE_BIN_DIR := $(ROOT_DIR)/bins
BASE_OBJ_DIR := $(ROOT_DIR)/objs
BASE_LIB_DIR := $(ROOT_DIR)/libs
BASE_OTHER_DIR := $(ROOT_DIR)/other
CONFIG_DIR := ./config/default
LINKER_DIR := $(ROOT_DIR)/linker

# Single output directories (no build config subdirectories)
OUT_DIR := $(ROOT_DIR)/bins
OBJ_DIR := $(ROOT_DIR)/objs
LIB_DIR := $(ROOT_DIR)/libs
OTHER_DIR := $(ROOT_DIR)/other

# MikroE Bootloader configuration
USE_MIKROE_BOOTLOADER := {{USE_MIKROE_BOOTLOADER}}

# Dynamic source file discovery (6 levels deep)
define get_c_files
$(wildcard $(1)/*.c) $(wildcard $(1)/*/*.c) $(wildcard $(1)/*/*/*.c) \
$(wildcard $(1)/*/*/*/*.c) $(wildcard $(1)/*/*/*/*/*.c) $(wildcard $(1)/*/*/*/*/*/*.c)
endef

define get_s_files
$(wildcard $(1)/*.S) $(wildcard $(1)/*/*.S) $(wildcard $(1)/*/*/*.S) \
$(wildcard $(1)/*/*/*/*.S) $(wildcard $(1)/*/*/*/*/*.S) $(wildcard $(1)/*/*/*/*/*/*.S)
endef

define get_inc_dirs
$(sort $(dir $(wildcard $(1)/*/.))) \
$(sort $(dir $(wildcard $(1)/*/*/.))) \
$(sort $(dir $(wildcard $(1)/*/*/*/.))) \
$(sort $(dir $(wildcard $(1)/*/*/*/*/.))) \
$(sort $(dir $(wildcard $(1)/*/*/*/*/*/.)))
endef

# Discover all source files
ALL_SRCS := $(call get_c_files,$(SRC_DIR))
ALL_ASM_SRCS := $(call get_s_files,$(SRC_DIR))

# Exclude startup directory from dynamic discovery (handled separately below)
EXCLUDED_FILES := $(wildcard startup/*.S)

# Filter excluded files
SRCS := $(filter-out $(EXCLUDED_FILES),$(ALL_SRCS))
ASM_SRCS := $(filter-out $(EXCLUDED_FILES),$(ALL_ASM_SRCS))

# Convert sources to object files with proper paths (use notdir to avoid nested subdirs)
OBJS := $(patsubst %.c,$(OBJ_DIR)/%.o,$(notdir $(SRCS)))

# MikroE Bootloader: Create startup object file if enabled
ifeq ($(USE_MIKROE_BOOTLOADER),yes)
	ASM_OBJS := $(OBJ_DIR)/startup.o
else
	ASM_OBJS := $(patsubst %.S,$(OBJ_DIR)/%.o,$(notdir $(ASM_SRCS)))
endif

# All objects
ALL_OBJS := $(OBJS) $(ASM_OBJS)

# Discover all source subdirectories
SRC_DIRS := $(sort $(dir $(SRCS) $(ASM_SRCS)))
SRC_SUBDIRS := $(sort $(filter-out startup/,$(SRC_DIRS:$(SRC_DIR)/%=%)))

# Set up vpath to search for sources in all discovered directories
vpath %.c $(SRC_DIR) $(addprefix $(SRC_DIR)/,$(SRC_SUBDIRS))
vpath %.S $(SRC_DIR) $(SRC_DIR)/startup

# Discover all include directories dynamically (5 levels deep)
INC_DIRS_SRC := $(call get_inc_dirs,$(SRC_DIR))
INC_DIRS_INC := $(call get_inc_dirs,$(INC_DIR))

# Build include flags dynamically
INC_FLAGS := -I$(SRC_DIR) -I$(INC_DIR) $(foreach dir,$(INC_DIRS_SRC),-I$(dir)) $(foreach dir,$(INC_DIRS_INC),-I$(dir)) -I"$(DFP_INC)"

# Compiler flags (build configuration-specific)
ifeq ($(BUILD_CONFIG),Debug)
	CFLAGS := -g3 -O0 -DDEBUG
else
	CFLAGS := -g -O2 -DNDEBUG
endif

# Common compiler flags
CFLAGS += -mprocessor=$(DEVICE)
CFLAGS += -mdfp="$(DFP)"
CFLAGS += -Wall -Wextra -Wno-unused-parameter
CFLAGS += -fno-common -ffunction-sections -fdata-sections
CFLAGS += -mno-smart-io
CFLAGS += $(INC_FLAGS)

# MikroE Bootloader defines
ifeq ($(USE_MIKROE_BOOTLOADER),yes)
	CFLAGS += -DUSE_MIKROE_BOOTLOADER
endif

# Linker flags
LDFLAGS := -mprocessor=$(DEVICE)
LDFLAGS += -mdfp="$(DFP)"
LDFLAGS += -Wl,--gc-sections
LDFLAGS += -Wl,--defsym=_min_heap_size=$(HEAP_SIZE)
LDFLAGS += -Wl,--defsym=_min_stack_size=$(STACK_SIZE)
LDFLAGS += -L"$(DFP_LIB)"

# MikroE Bootloader: Don't use default startup files
ifeq ($(USE_MIKROE_BOOTLOADER),yes)
	LDFLAGS += -nostartfiles
endif

# Output files
ELF := $(OUT_DIR)/$(MODULE).elf
HEX := $(OUT_DIR)/$(MODULE).hex
MAP := $(OTHER_DIR)/$(MODULE).map

# Default target - Build project
all: $(HEX)
	@echo ""
	@echo "=========================================="
	@echo "  Build Complete: $(MODULE)"
	@echo "=========================================="
	@echo "  Device:     $(DEVICE)"
	@echo "  Config:     $(BUILD_CONFIG)"
	@echo "  XC32:       $(XC32_VERSION)"
	@echo "  DFP:        $(DFP_VERSION)"
	@echo "  Output:     $(HEX)"
	@echo "=========================================="
	$(SIZE) $(ELF)

# Generate HEX from ELF
$(HEX): $(ELF) | $(OUT_DIR)
	@echo "Creating HEX file: $@"
	$(OBJCOPY) $(ELF)

# Link ELF
$(ELF): $(ALL_OBJS) | $(OUT_DIR) $(OTHER_DIR)
	@echo "Linking $(MODULE)..."
	$(LD) $(LDFLAGS) -Wl,-Map=$(MAP) -o $@ $(ALL_OBJS)

# Pattern rule for compiling .c files from any discovered directory
$(OBJ_DIR)/%.o: %.c | $(OBJ_DIR)
	@echo "Compiling $<..."
	$(CC) $(CFLAGS) -c -o $@ $<

# Pattern rule for assembling .S files
$(OBJ_DIR)/%.o: %.S | $(OBJ_DIR)
	@echo "Assembling $<..."
	$(CC) $(CFLAGS) -c -o $@ $<

# Compile main.c from srcs/ (kept for clarity, but pattern rule handles it)
$(OBJ_DIR)/main.o: main.c | $(OBJ_DIR)
	@echo "Compiling $<..."
	$(CC) $(CFLAGS) -c -o $@ $<

# Compile initialization.c from config/default/
$(OBJ_DIR)/initialization.o: $(CONFIG_DIR)/initialization.c | $(OBJ_DIR)
	@echo "Compiling $<..."
	$(CC) $(CFLAGS) -c -o $@ $<

# Compile startup.S if using MikroE bootloader
ifeq ($(USE_MIKROE_BOOTLOADER),yes)
$(OBJ_DIR)/startup.o: startup/startup.S | $(OBJ_DIR)
	@echo "Assembling $<..."
	$(CC) $(CFLAGS) -c -o $@ $<
endif

# Create directory structure and move headers
build_dir:
	@echo "========================================"
	@echo "  Creating Build Directories"
	@echo "========================================"
	@echo "Platform: $(detected_OS)"
	@echo "DRY_RUN:  $(DRY_RUN)"
	@echo ""
	@echo "Creating base directories..."
	@$(call MKDIR,$(ROOT_DIR)/bins)
	@$(call MKDIR,$(ROOT_DIR)/incs)
	@$(call MKDIR,$(ROOT_DIR)/libs)
	@$(call MKDIR,$(ROOT_DIR)/objs)
	@$(call MKDIR,$(ROOT_DIR)/other)
	@$(call MKDIR,$(SRC_DIR))
	@echo ""
	@echo "Discovering and moving header files..."
	@$(foreach header,$(wildcard $(SRC_DIR)/*.h),$(call MKDIR,$(INC_DIR));$(call MOVE,$(header),$(INC_DIR));)
	@$(foreach header,$(wildcard $(SRC_DIR)/*/*.h),$(call MKDIR,$(dir $(INC_DIR)/$(patsubst $(SRC_DIR)/%,%,$(header))));$(call MOVE,$(header),$(dir $(INC_DIR)/$(patsubst $(SRC_DIR)/%,%,$(header))));)
	@$(foreach header,$(wildcard $(SRC_DIR)/*/*/*.h),$(call MKDIR,$(dir $(INC_DIR)/$(patsubst $(SRC_DIR)/%,%,$(header))));$(call MOVE,$(header),$(dir $(INC_DIR)/$(patsubst $(SRC_DIR)/%,%,$(header))));)
	@$(foreach header,$(wildcard $(SRC_DIR)/*/*/*/*.h),$(call MKDIR,$(dir $(INC_DIR)/$(patsubst $(SRC_DIR)/%,%,$(header))));$(call MOVE,$(header),$(dir $(INC_DIR)/$(patsubst $(SRC_DIR)/%,%,$(header))));)
	@$(foreach header,$(wildcard $(SRC_DIR)/*/*/*/*/*.h),$(call MKDIR,$(dir $(INC_DIR)/$(patsubst $(SRC_DIR)/%,%,$(header))));$(call MOVE,$(header),$(dir $(INC_DIR)/$(patsubst $(SRC_DIR)/%,%,$(header))));)
	@echo "Headers moved"
	@echo ""
	@echo "========================================"
	@echo "  Directory Structure Ready"
	@echo "========================================"

# Create required directories
$(OUT_DIR):
	@$(call MKDIR,$@)

$(OBJ_DIR):
	@$(call MKDIR,$@)

$(LIB_DIR):
	@$(call MKDIR,$@)

$(OTHER_DIR):
	@$(call MKDIR,$@)

# Clean build artifacts
clean:
	@echo "Cleaning build artifacts for $(BUILD_CONFIG)..."
ifeq ($(DRY_RUN),1)
	@echo "DRY_RUN=1: Would remove $(OBJ_DIR)"
	@echo "DRY_RUN=1: Would remove $(OUT_DIR)"
	@echo "DRY_RUN=1: Would remove $(OTHER_DIR)"
else
	@$(call RMDIR,$(OBJ_DIR))
	@$(call RMDIR,$(OUT_DIR))
	@$(call RMDIR,$(OTHER_DIR))
endif
	@echo "Clean complete"

# Show compiler version
version:
	@echo "XC32 Compiler Version:"
	@$(CC) --version

# Debug - show discovered sources
debug:
	@echo "=========================================="
	@echo "  Build Configuration"
	@echo "=========================================="
	@echo "MODULE:           $(MODULE)"
	@echo "DEVICE:           $(DEVICE)"
	@echo "BUILD_CONFIG:     $(BUILD_CONFIG)"
	@echo "XC32_VERSION:     $(XC32_VERSION)"
	@echo "DFP_VERSION:      $(DFP_VERSION)"
	@echo "USE_BOOTLOADER:   $(USE_MIKROE_BOOTLOADER)"
	@echo "DRY_RUN:          $(DRY_RUN)"
	@echo ""
	@echo "Directories:"
	@echo "  SRC_DIR:        $(SRC_DIR)"
	@echo "  INC_DIR:        $(INC_DIR)"
	@echo "  OBJ_DIR:        $(OBJ_DIR)"
	@echo "  OUT_DIR:        $(OUT_DIR)"
	@echo "  DFP_PATH:       $(DFP_PATH)"
	@echo ""
	@echo "Source Files ($(words $(SRCS))):"
	@$(foreach src,$(SRCS),echo "  $(src)";)
	@echo ""
	@echo "Assembly Files ($(words $(ASM_SRCS))):"
	@$(foreach src,$(ASM_SRCS),echo "  $(src)";)
	@echo ""
	@echo "Config Files ($(words $(CONFIG_SRCS))):"
	@$(foreach src,$(CONFIG_SRCS),echo "  $(src)";)
	@echo ""
	@echo "Source Subdirectories:"
	@$(foreach subdir,$(SRC_SUBDIRS),echo "  $(subdir)";)
	@echo ""
	@echo "Include Directories from SRC:"
	@$(foreach inc,$(INC_DIRS_SRC),echo "  $(inc)";)
	@echo ""
	@echo "Include Directories from INC:"
	@$(foreach inc,$(INC_DIRS_INC),echo "  $(inc)";)
	@echo "=========================================="

.PHONY: all build_dir clean version debug
